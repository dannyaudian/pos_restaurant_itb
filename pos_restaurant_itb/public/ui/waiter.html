<!DOCTYPE html>
<html>
<head>
  <title>POS Waiter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; padding: 20px; }
    .section { margin-bottom: 20px; }
    label { display: block; margin: 5px 0 2px; }
    input, select, button { padding: 5px; width: 100%; max-width: 400px; }
    .item-row { margin: 5px 0; padding: 5px; border: 1px solid #ddd; }
    .sent { color: green; font-weight: bold; }
    .pending { color: red; }
    #main_ui { display: none; }
    #btn_served { display: none; margin-top: 10px; background: #1d4ed8; color: white; }
  </style>
</head>
<body>

<!-- LOGIN -->
<div id="login_ui">
  <h2>Login</h2>
  <div class="section">
    <label for="username">Username</label>
    <input type="text" id="username">
  </div>
  <div class="section">
    <label for="password">Password</label>
    <input type="password" id="password">
  </div>
  <div class="section">
    <button onclick="doLogin()">Login</button>
  </div>
</div>

<!-- MAIN -->
<div id="main_ui">
  <div class="section" id="branch_select_container" style="display:none;">
    <label>Select Branch</label>
    <select id="branch_select"></select>
  </div>

  <div class="section">
    <h3>Meja Aktif</h3>
    <div id="table_list"></div>
    <button onclick="newOrderPrompt()">+ Buat Order Baru</button>
  </div>

  <div id="order_section" style="display:none;">
    <h3>Order</h3>
    <div class="section">
      <strong>Meja: </strong><span id="current_table_display"></span><br>
      <strong>Order ID: </strong><span id="current_order_display"></span>
    </div>

    <div class="section" id="new_item_form">
      <h4>Tambah Item</h4>
      <label>Item Code</label>
      <input type="text" id="item_code">
      <label>Item Name</label>
      <input type="text" id="item_name">
      <label>Qty</label>
      <input type="number" id="qty" value="1">
      <label>Note (opsional)</label>
      <input type="text" id="note">
      <button onclick="addItem()">Tambah</button>
    </div>

    <div id="item_list" class="section"></div>

    <div class="section">
      <button onclick="saveOrder()">ðŸ’¾ Simpan</button>
      <button onclick="sendToKitchen()">ðŸš€ Kirim ke Dapur</button>
      <button id="btn_served" onclick="markAsServed()">âœ… Tandai Sudah Diantar</button>
    </div>
  </div>
</div>

<script>
let currentItems = [];
let currentOrderId = "";
let currentTable = "";
let loggedInUser = "";
let selectedBranch = "";

let autoRefreshInterval = null;

function startAutoRefresh() {
  if (autoRefreshInterval) clearInterval(autoRefreshInterval);
  autoRefreshInterval = setInterval(() => {
    if (currentOrderId) loadOrder();
  }, 10000); // auto-refresh tiap 10 detik
}


async function doLogin() {
  const username = document.getElementById("username").value;
  const password = document.getElementById("password").value;

  const res = await fetch("/api/method/login", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: `usr=${username}&pwd=${password}`
  });

  const data = await res.json();
  if (data.message === "Logged In") {
    loggedInUser = username;
    document.getElementById("login_ui").style.display = "none";
    document.getElementById("main_ui").style.display = "block";
    checkRoleAndLoadBranches();
  } else {
    alert("Login gagal.");
  }
}

async function checkRoleAndLoadBranches() {
  const res = await fetch(`/api/resource/User/${loggedInUser}`);
  const userData = await res.json();
  const roles = userData.data.roles.map(r => r.role);

  if (!roles.includes("System Manager")) {
    const permRes = await fetch(`/api/method/frappe.client.get_list`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        doctype: "User Permission",
        filters: { user: loggedInUser, allow: "Branch" },
        fields: ["for_value"]
      })
    });

    const permData = await permRes.json();
    const allowed = permData.message.map(x => x.for_value);
    if (!allowed.length) return alert("Tidak ada cabang yang diizinkan.");

    const select = document.getElementById("branch_select");
    select.innerHTML = "";
    allowed.forEach(branch => {
      const opt = document.createElement("option");
      opt.value = branch;
      opt.textContent = branch;
      select.appendChild(opt);
    });

    document.getElementById("branch_select_container").style.display = "block";
    selectedBranch = allowed[0];
    select.addEventListener("change", () => {
      selectedBranch = select.value;
      loadActiveTables();
    });
  }
  loadActiveTables();
}

async function loadActiveTables() {
  const res = await fetch(`/api/resource/POS Order?fields=["name","table","status","branch"]&limit_page_length=50`);
  const data = await res.json();
  const list = document.getElementById("table_list");
  list.innerHTML = "";

  data.data.forEach(order => {
    if (order.branch !== selectedBranch) return;
    const btn = document.createElement("button");
    btn.textContent = `Meja ${order.table} (${order.status})`;
    btn.onclick = () => { currentOrderId = order.name; loadOrder(); };
    list.appendChild(btn);
  });
}

function newOrderPrompt() {
  const meja = prompt("Nomor Meja?");
  if (!meja) return;

  clearInterval(autoRefreshInterval);

  currentTable = meja;
  currentItems = [];
  currentOrderId = "";
  document.getElementById("order_section").style.display = "block";
  document.getElementById("current_table_display").textContent = meja;
  document.getElementById("current_order_display").textContent = "-";
  document.getElementById("item_list").innerHTML = "";
  document.getElementById("btn_served").style.display = "none";
}

function addItem() {
  const item = {
    item_code: document.getElementById("item_code").value,
    item_name: document.getElementById("item_name").value,
    qty: parseFloat(document.getElementById("qty").value),
    note: document.getElementById("note").value,
    sent_to_kitchen: 0
  };
  currentItems.push(item);
  renderItems();
}

async function saveOrder() {
  if (!currentTable || !selectedBranch) return alert("Isi data terlebih dahulu.");

  const payload = {
    doctype: "POS Order",
    branch: selectedBranch,
    table: currentTable,
    pos_order_items: currentItems
  };

  const res = await fetch("/api/resource/POS Order" + (currentOrderId ? "/" + currentOrderId : ""), {
    method: currentOrderId ? "PUT" : "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const data = await res.json();
  if (data.data) {
    currentOrderId = data.data.name;
    document.getElementById("current_order_display").textContent = currentOrderId;
    alert("Order berhasil disimpan.");
    loadActiveTables();
  } else {
    alert("Gagal menyimpan order.");
  }
}

async function loadOrder() {
  const res = await fetch(`/api/resource/POS Order/${currentOrderId}`);
  const data = await res.json();
  if (!data.data) return alert("Order tidak ditemukan.");

  currentItems = data.data.pos_order_items || [];
  currentTable = data.data.table;

  document.getElementById("current_table_display").textContent = currentTable;
  document.getElementById("current_order_display").textContent = currentOrderId;
  document.getElementById("order_section").style.display = "block";
  renderItems();

  startAutoRefresh();
}

function renderItems() {
  const container = document.getElementById("item_list");
  container.innerHTML = "";
  let allReady = true;

  currentItems.forEach(item => {
    const isSent = item.sent_to_kitchen;
    const kotStatus = item.kot_status || (isSent ? "Sent" : "Pending");

    const row = document.createElement("div");
    row.className = "item-row";
    row.innerHTML = `
      <strong>${item.item_name}</strong> (x${item.qty})<br>
      ${item.note ? "Note: " + item.note + "<br>" : ""}
      Status: ${isSent ? `<span class="sent">${kotStatus}</span>` : `<span class="pending">${kotStatus}</span>`}
    `;
    container.appendChild(row);

    // Cek apakah semua item "Ready"
    if (isSent && kotStatus !== "Ready") {
      allReady = false;
    }
  });

  const btnServed = document.getElementById("btn_served");
  btnServed.style.display = (allReady && currentItems.length > 0) ? "inline-block" : "none";
}

async function sendToKitchen() {
  if (!currentOrderId) return alert("Order belum disimpan.");
  const res = await fetch("/api/method/pos_restaurant_itb.api.send_to_kitchen", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ pos_order: currentOrderId })
  });
  const data = await res.json();
  if (data.message) {
    alert("Dikirim ke dapur: " + data.message);
    loadOrder();
  } else {
    alert("Gagal kirim.");
  }
}

async function markAsServed() {
  const confirmMark = confirm("Tandai semua item sudah diantar dan ubah status ke 'Served'?");
  if (!confirmMark) return;

  const res = await fetch(`/api/resource/Kitchen Display Order?filters=[["kot_id","=","${currentOrderId}"]]`);
  const data = await res.json();
  if (!data.data || !data.data.length) return alert("KDS tidak ditemukan.");

  const kdsDoc = data.data[0];
  const update = await fetch(`/api/resource/Kitchen Display Order/${kdsDoc.name}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ status: "Served" })
  });

  const updated = await update.json();
  if (updated.data) {
    alert("Berhasil ditandai sebagai 'Served'.");
    loadOrder();
  } else {
    alert("Gagal update status.");
  }
}
</script>
</body>
</html>
