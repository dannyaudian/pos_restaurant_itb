<!DOCTYPE html>
<html>
<head>
    <title>POS Order - Restaurant Management</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Frappe framework dependencies -->
    <script src="/assets/frappe/js/frappe.min.js"></script>
    <link href="/assets/frappe/css/frappe.min.css" rel="stylesheet">
    <!-- Additional CSS -->
    <style>
        :root {
            --primary-color: #2490ef;
            --secondary-color: #6c757d;
        }
        
        body {
            font-family: sans-serif;
            background-color: #f5f7fa;
            padding: 20px;
        }
        
        .order-header {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .order-items {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .status-badge {
            font-size: 0.9rem;
            padding: 6px 12px;
            border-radius: 20px;
        }
        
        .table {
            width: 100%;
            margin-bottom: 1rem;
            border-collapse: collapse;
        }
        
        .table th, .table td {
            padding: 0.75rem;
            border: 1px solid #dee2e6;
        }
        
        .table th {
            background-color: #f8f9fa;
        }
        
        .cancelled-item {
            background-color: #fff3f3;
            text-decoration: line-through;
        }
        
        .kot-status {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }
        
        .kot-status.served {
            background-color: #d4edda;
            color: #155724;
        }
        
        .kot-status.cancelled {
            background-color: #f8d7da;
            color: #721c24;
        }

        .required-field::after {
            content: " *";
            color: red;
        }
    </style>
</head>
<body>
    <div class="order-header">
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label class="form-label required-field">Order ID</label>
                    <input type="text" class="form-control" id="order_id" required readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Table</label>
                    <select class="form-control" id="table">
                        <option value="">Select Table</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label required-field">Branch</label>
                    <select class="form-control" id="branch" required>
                        <option value="">Select Branch</option>
                    </select>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="form-label">Order Type</label>
                    <select class="form-control" id="order_type">
                        <option value="Dine In">Dine In</option>
                        <option value="Takeaway">Takeaway</option>
                        <option value="Delivery">Delivery</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Customer</label>
                    <select class="form-control" id="customer">
                        <option value="">Select Customer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <span class="status-badge badge bg-warning" id="status">Draft</span>
                </div>
            </div>
        </div>
    </div>

    <div class="order-items">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4>Order Items</h4>
            <button class="btn btn-primary" id="add_item">Add Item</button>
        </div>
        
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Item Code</th>
                        <th>Item Name</th>
                        <th>Qty</th>
                        <th>Rate</th>
                        <th>Amount</th>
                        <th>Attributes</th>
                        <th>KOT Status</th>
                        <th>Note</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="items_table"></tbody>
            </table>
        </div>

        <div class="total-section bg-light p-3 rounded mt-3">
            <div class="row">
                <div class="col-md-8">
                    <div id="kot_info"></div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex justify-content-between">
                        <strong>Total Amount:</strong>
                        <span id="total_amount" class="h5 mb-0">0.00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="action-buttons d-flex justify-content-end mt-3">
        <button class="btn btn-secondary me-2" id="save_draft">Save as Draft</button>
        <button class="btn btn-primary me-2" id="send_to_kitchen">Send to Kitchen</button>
        <button class="btn btn-info me-2" id="print_kot">Print KOT</button>
        <button class="btn btn-success me-2" id="print_receipt">Print Receipt</button>
        <button class="btn btn-warning me-2" id="mark_all_served">Mark All Served</button>
        <button class="btn btn-danger" id="cancel_order">Cancel Order</button>
    </div>

    <!-- Item Modal -->
    <div class="modal" id="itemModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add/Edit Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label required-field">Item Code</label>
                                <select class="form-control" id="modal_item_code" required>
                                    <option value="">Select Item</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label required-field">Quantity</label>
                                <input type="number" class="form-control" id="modal_qty" value="1" min="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Note</label>
                                <textarea class="form-control" id="modal_note" rows="2"></textarea>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div id="dynamic_attributes_container">
                                <!-- Dynamic attributes will be added here -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="confirm_item">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Cancel Item Modal -->
    <div class="modal" id="cancelItemModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Cancel Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label class="form-label required-field">Cancellation Note</label>
                        <textarea class="form-control" id="cancellation_note" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-danger" id="confirm_cancel">Cancel Item</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Include Frappe scripts -->
    <script>
        frappe.ready(function() {
            // Initialize the POS Order page
            class POSOrder {
                constructor() {
                    this.bindEvents();
                    this.setupFilters();
                }

                bindEvents() {
                    $('#table').on('change', () => this.onTableChange());
                    $('#send_to_kitchen').on('click', () => this.sendToKitchen());
                    $('#mark_all_served').on('click', () => this.markAllServed());
                    $(document).on('click', '.cancel-item-btn', (e) => this.showCancelDialog(e));
                }

                setupFilters() {
                    // Setup branch filter
                    frappe.call({
                        method: 'frappe.client.get_list',
                        args: {
                            doctype: 'Branch',
                            fields: ['name'],
                            filters: { is_active: 1 }
                        },
                        callback: (r) => {
                            const branches = r.message || [];
                            this.populateBranchSelect(branches);
                        }
                    });

                    // Setup table filter based on branch
                    $('#branch').on('change', (e) => {
                        this.loadTables(e.target.value);
                    });
                }

                async sendToKitchen() {
                    const orderId = $('#order_id').val();
                    if (!orderId) return;

                    try {
                        const result = await frappe.call({
                            method: 'pos_restaurant_itb.api.sendkitchenandcancel.send_to_kitchen',
                            args: { pos_order: orderId }
                        });

                        if (result.message) {
                            // Show KOT print preview
                            const printWindow = window.open('', '_blank');
                            printWindow.document.write(result.message);
                            printWindow.document.close();
                            
                            // Refresh the page
                            location.reload();
                        }
                    } catch (error) {
                        frappe.msgprint({
                            title: __('Error'),
                            indicator: 'red',
                            message: __(error.message || 'Failed to send to kitchen')
                        });
                    }
                }

                async markAllServed() {
                    const orderId = $('#order_id').val();
                    if (!orderId) return;

                    frappe.confirm(
                        'Are you sure you want to mark all items as served?',
                        async () => {
                            try {
                                const result = await frappe.call({
                                    method: 'pos_restaurant_itb.api.sendkitchenandcancel.mark_all_served',
                                    args: { pos_order_id: orderId }
                                });

                                if (result.message) {
                                    frappe.show_alert({
                                        message: result.message,
                                        indicator: 'green'
                                    });
                                    location.reload();
                                }
                            } catch (error) {
                                frappe.msgprint({
                                    title: __('Error'),
                                    indicator: 'red',
                                    message: __(error.message || 'Failed to mark items as served')
                                });
                            }
                        }
                    );
                }

                showCancelDialog(event) {
                    const row = $(event.target).closest('tr');
                    const itemName = row.data('item-name');

                    frappe.prompt([
                        {
                            label: 'Cancellation Note',
                            fieldname: 'reason',
                            fieldtype: 'Small Text',
                            reqd: 1
                        }
                    ],
                    (values) => {
                        this.cancelItem(itemName, values.reason);
                    },
                    'Cancel Item',
                    'Confirm'
                    );
                }

                async cancelItem(itemName, reason) {
                    try {
                        const result = await frappe.call({
                            method: 'pos_restaurant_itb.api.sendkitchenandcancel.cancel_pos_order_item',
                            args: {
                                item_name: itemName,
                                reason: reason
                            }
                        });

                        if (result.message) {
                            frappe.show_alert({
                                message: result.message.message,
                                indicator: 'green'
                            });
                            location.reload();
                        }
                    } catch (error) {
                        frappe.msgprint({
                            title: __('Error'),
                            indicator: 'red',
                            message: __(error.message || 'Failed to cancel item')
                        });
                    }
                }
            }

            // Initialize POS Order
            window.posOrder = new POSOrder();
        });
    </script>
</body>
</html>
