<!DOCTYPE html>
<html>
<head>
    <title>POS Order</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Frappe framework dependencies -->
    <script src="/assets/frappe/js/frappe.min.js"></script>
    <link href="/assets/frappe/css/frappe.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <style>
        .order-container {
            padding: 20px;
        }
        
        .order-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .item-row {
            border-bottom: 1px solid #eee;
            padding: 8px 0;
        }
        
        .item-row:last-child {
            border-bottom: none;
        }
        
        .kot-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .kot-new { background: #fff3cd; color: #856404; }
        .kot-in-progress { background: #cce5ff; color: #004085; }
        .kot-ready { background: #d4edda; color: #155724; }
        .kot-served { background: #d6d8db; color: #383d41; }
        .kot-cancelled { background: #f8d7da; color: #721c24; }
        
        .cancelled-item {
            background-color: #fff3f3;
            text-decoration: line-through;
        }
    </style>
</head>
<body>
    <div class="order-container">
        <!-- Header Section -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 id="page_title">POS Order</h3>
            <div>
                <button class="btn btn-secondary me-2" onclick="window.location.href='/pos_order_list'">
                    <i class="fas fa-arrow-left"></i> Back to List
                </button>
                <button class="btn btn-primary" id="save_order">
                    <i class="fas fa-save"></i> Save Order
                </button>
            </div>
        </div>

        <!-- Order Details Section -->
        <div class="order-section">
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="form-label">Table Number</label>
                        <input type="text" class="form-control" id="table_no" required>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="form-label">Order Type</label>
                        <select class="form-control" id="order_type">
                            <option value="Dine In">Dine In</option>
                            <option value="Takeaway">Takeaway</option>
                            <option value="Delivery">Delivery</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label class="form-label">Customer</label>
                        <input type="text" class="form-control" id="customer">
                    </div>
                </div>
            </div>
        </div>

        <!-- Items Section -->
        <div class="order-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>Order Items</h4>
                <button class="btn btn-primary btn-sm" id="add_item">
                    <i class="fas fa-plus"></i> Add Item
                </button>
            </div>
            
            <div class="table-responsive">
                <table class="table" id="items_table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Qty</th>
                            <th>Rate</th>
                            <th>Amount</th>
                            <th>Note</th>
                            <th>KOT Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" class="text-end"><strong>Total:</strong></td>
                            <td id="total_amount">0.00</td>
                            <td colspan="3"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="order-section">
            <div class="d-flex justify-content-end gap-2">
                <button class="btn btn-secondary me-2" id="print_kot">
                    <i class="fas fa-print"></i> Print KOT
                </button>
                <button class="btn btn-primary me-2" id="send_to_kitchen">
                    <i class="fas fa-utensils"></i> Send to Kitchen
                </button>
                <button class="btn btn-success" id="mark_all_served">
                    <i class="fas fa-check-circle"></i> Mark All Served
                </button>
            </div>
        </div>
    </div>

    <!-- Item Modal -->
    <div class="modal" id="itemModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group mb-3">
                        <label class="form-label">Item</label>
                        <select class="form-control" id="modal_item_code" required>
                            <option value="">Select Item</option>
                        </select>
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">Quantity</label>
                        <input type="number" class="form-control" id="modal_qty" value="1" min="1">
                    </div>
                    <div class="form-group mb-3">
                        <label class="form-label">Note</label>
                        <textarea class="form-control" id="modal_note" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="confirm_add_item">Add</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        frappe.ready(function() {
            class POSOrder {
                constructor() {
                    this.orderId = frappe.get_url_arg('name');
                    this.items = [];
                    this.initialize();
                }

                async initialize() {
                    await this.loadOrderData();
                    this.setupEventHandlers();
                    await this.loadItems();
                }

                async loadOrderData() {
                    if (this.orderId) {
                        const result = await frappe.call({
                            method: "pos_restaurant_itb.api.pos_order_controller.get_order_context",
                            args: { order_name: this.orderId }
                        });
                        
                        if (result.message?.doc) {
                            const order = result.message.doc;
                            $('#page_title').text(`Edit Order - ${order.name}`);
                            $('#table_no').val(order.table);
                            $('#order_type').val(order.order_type);
                            $('#customer').val(order.customer);
                            this.items = order.items || [];
                            this.renderItems();
                        }
                    }
                }

                setupEventHandlers() {
                    $('#add_item').on('click', () => this.showItemModal());
                    $('#confirm_add_item').on('click', () => this.addItem());
                    $('#send_to_kitchen').on('click', () => this.sendToKitchen());
                    $('#mark_all_served').on('click', () => this.markAllServed());
                    $('#save_order').on('click', () => this.saveOrder());
                }

                async loadItems() {
                    const result = await frappe.call({
                        method: "frappe.client.get_list",
                        args: {
                            doctype: "Item",
                            fields: ["name", "item_name", "standard_rate"],
                            filters: { is_sales_item: 1 }
                        }
                    });

                    const select = $('#modal_item_code');
                    select.empty().append('<option value="">Select Item</option>');
                    
                    result.message?.forEach(item => {
                        select.append(`<option value="${item.name}" data-rate="${item.standard_rate}">
                            ${item.item_name}
                        </option>`);
                    });
                }

                showItemModal() {
                    $('#itemModal').modal('show');
                }

                addItem() {
                    const itemCode = $('#modal_item_code').val();
                    const qty = parseInt($('#modal_qty').val()) || 1;
                    const note = $('#modal_note').val();
                    const rate = parseFloat($('#modal_item_code option:selected').data('rate')) || 0;

                    if (!itemCode) {
                        frappe.msgprint('Please select an item');
                        return;
                    }

                    const item = {
                        item_code: itemCode,
                        item_name: $('#modal_item_code option:selected').text().trim(),
                        qty: qty,
                        rate: rate,
                        amount: qty * rate,
                        note: note,
                        kot_status: 'New'
                    };

                    this.items.push(item);
                    this.renderItems();
                    $('#itemModal').modal('hide');
                    this.resetItemModal();
                }

                renderItems() {
                    const tbody = $('#items_table tbody');
                    tbody.empty();

                    let total = 0;
                    this.items.forEach((item, index) => {
                        if (!item.cancelled) {
                            total += item.amount;
                        }

                        const row = `
                            <tr class="${item.cancelled ? 'cancelled-item' : ''}">
                                <td>${item.item_name}</td>
                                <td>${item.qty}</td>
                                <td>${frappe.format_currency(item.rate)}</td>
                                <td>${frappe.format_currency(item.amount)}</td>
                                <td>${item.note || ''}</td>
                                <td>
                                    <span class="kot-status kot-${item.kot_status.toLowerCase().replace(/\s+/g, '-')}">
                                        ${item.kot_status}
                                    </span>
                                </td>
                                <td>
                                    ${!item.cancelled ? `
                                        <button class="btn btn-danger btn-sm" onclick="window.posOrder.cancelItem(${index})">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    ` : ''}
                                </td>
                            </tr>
                        `;
                        tbody.append(row);
                    });

                    $('#total_amount').text(frappe.format_currency(total));
                }

                async sendToKitchen() {
                    if (!this.orderId) {
                        frappe.msgprint('Please save the order first');
                        return;
                    }

                    try {
                        const result = await frappe.call({
                            method: "pos_restaurant_itb.api.sendkitchenandcancel.send_to_kitchen",
                            args: { pos_order: this.orderId }
                        });

                        if (result.message) {
                            const printWindow = window.open('', '_blank');
                            printWindow.document.write(result.message);
                            printWindow.document.close();
                            await this.loadOrderData();
                        }
                    } catch (error) {
                        frappe.msgprint(error.message);
                    }
                }

                async markAllServed() {
                    if (!this.orderId) {
                        frappe.msgprint('Please save the order first');
                        return;
                    }

                    try {
                        const result = await frappe.call({
                            method: "pos_restaurant_itb.api.sendkitchenandcancel.mark_all_served",
                            args: { pos_order_id: this.orderId }
                        });

                        if (result.message) {
                            frappe.show_alert({
                                message: result.message,
                                indicator: 'green'
                            });
                            await this.loadOrderData();
                        }
                    } catch (error) {
                        frappe.msgprint(error.message);
                    }
                }

                async saveOrder() {
                    const orderData = {
                        doctype: 'POS Order',
                        table: $('#table_no').val(),
                        order_type: $('#order_type').val(),
                        customer: $('#customer').val(),
                        items: this.items
                    };

                    try {
                        const result = await frappe.call({
                            method: "pos_restaurant_itb.api.pos_order_controller.create_or_update_order",
                            args: {
                                order_data: orderData,
                                order_name: this.orderId
                            }
                        });

                        if (result.message?.status === 'success') {
                            frappe.show_alert({
                                message: 'Order saved successfully',
                                indicator: 'green'
                            });
                            
                            if (!this.orderId) {
                                window.location.href = `/pos_order/${result.message.order_name}`;
                            }
                        } else {
                            frappe.msgprint(result.message?.message || 'Failed to save order');
                        }
                    } catch (error) {
                        frappe.msgprint(error.message);
                    }
                }

                cancelItem(index) {
                    frappe.confirm(
                        'Are you sure you want to cancel this item?',
                        () => {
                            this.items[index].cancelled = true;
                            this.items[index].amount = 0;
                            this.renderItems();
                        }
                    );
                }

                resetItemModal() {
                    $('#modal_item_code').val('');
                    $('#modal_qty').val(1);
                    $('#modal_note').val('');
                }
            }

            // Initialize POS Order
            window.posOrder = new POSOrder();
        });
    </script>
</body>
</html>
