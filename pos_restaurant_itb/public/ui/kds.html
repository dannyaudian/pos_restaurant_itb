<!DOCTYPE html>
<html>
<head>
  <title>KDS Display</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f5f5f5; }
    .section { margin-bottom: 20px; }
    .table-grid { display: flex; flex-wrap: wrap; gap: 20px; }
    .table-box {
      width: 300px; padding: 16px; border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.15); background: #fff;
      animation-duration: 1s; animation-iteration-count: infinite;
      cursor: pointer; transition: transform 0.2s ease-in-out;
    }
    .table-box:hover { transform: scale(1.02); }

    .status-new { background-color: #fffbe6; }
    .status-progress { background-color: #ffe0b2; }
    .status-ready { background-color: #d4edda; }
    .status-served { background-color: #dbeafe; }

    .blink { animation-name: blinker; }
    @keyframes blinker { 50% { opacity: 0.4; } }

    #main_ui { display: none; }

    .fullscreen-btn {
      position: fixed; top: 10px; right: 10px;
      background: #333; color: white; padding: 10px 20px;
      border: none; border-radius: 5px; z-index: 999;
    }

    .table-box ul { padding-left: 18px; font-size: 1.1em; }
    .table-box h4 { font-size: 1.4em; margin-bottom: 0.5em; }
  </style>
</head>
<body>

<!-- LOGIN UI -->
<div id="login_ui">
  <h2>KDS Login</h2>
  <div class="section">
    <label for="username">Username</label>
    <input type="text" id="username">
  </div>
  <div class="section">
    <label for="password">Password</label>
    <input type="password" id="password">
  </div>
  <div class="section">
    <button onclick="doLogin()">Login</button>
  </div>
</div>

<!-- MAIN UI -->
<div id="main_ui">
  <button class="fullscreen-btn" onclick="toggleFullscreen()">Fullscreen</button>

  <div class="section" id="branch_container" style="display:none;">
    <label for="branch_select">Select Branch</label>
    <select id="branch_select"></select>
  </div>

  <h3 id="branch_title">Kitchen Display</h3>
  <div class="table-grid" id="kds_container"></div>
</div>

<!-- sudah di atas head dan login sama -->
<!-- ... -->

<script>
    let loggedInUser = "";
    let selectedBranch = "";
  
    async function doLogin() {
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;
  
      const res = await fetch("/api/method/login", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `usr=${username}&pwd=${password}`
      });
  
      const data = await res.json();
      if (data.message === "Logged In") {
        loggedInUser = username;
        document.getElementById("login_ui").style.display = "none";
        document.getElementById("main_ui").style.display = "block";
        await checkRoleAndLoadBranches();
        refreshKDS();
        setInterval(refreshKDS, 5000); // Auto refresh setiap 5 detik
      } else {
        alert("Login gagal.");
      }
    }
  
    async function checkRoleAndLoadBranches() {
      const res = await fetch(`/api/resource/User/${loggedInUser}`);
      const userData = await res.json();
      const roles = userData.data.roles.map(r => r.role);
  
      if (!roles.includes("System Manager")) {
        const permRes = await fetch(`/api/method/frappe.client.get_list`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            doctype: "User Permission",
            filters: { user: loggedInUser, allow: "Branch" },
            fields: ["for_value"]
          })
        });
  
        const permData = await permRes.json();
        const branches = permData.message.map(x => x.for_value);
        if (!branches.length) return alert("Anda tidak punya akses ke cabang.");
  
        const select = document.getElementById("branch_select");
        select.innerHTML = "";
        branches.forEach(branch => {
          const opt = document.createElement("option");
          opt.value = branch;
          opt.textContent = branch;
          select.appendChild(opt);
        });
  
        selectedBranch = branches[0];
        document.getElementById("branch_title").innerText = `Kitchen Display - ${selectedBranch}`;
        document.getElementById("branch_container").style.display = "block";
  
        select.addEventListener("change", () => {
          selectedBranch = select.value;
          document.getElementById("branch_title").innerText = `Kitchen Display - ${selectedBranch}`;
          refreshKDS();
        });
      }
    }
  
    async function fetchKDSData() {
      const res = await fetch(`/api/resource/Kitchen Display Order?filters=[["branch","=","${selectedBranch}"]]`);
      const json = await res.json();
      return json.data || [];
    }
  
    function getStatusClass(status) {
      switch (status) {
        case "New": return "status-new";
        case "In Progress": return "status-progress";
        case "Ready": return "status-ready";
        case "Served": return "status-served";
        default: return "";
      }
    }
  
    function isBlinking(items) {
      return items.some(i => i.kot_status === "Queued");
    }
  
    function getNextStatus(current) {
      const statuses = ["New", "In Progress", "Ready", "Served"];
      const index = statuses.indexOf(current);
      if (index >= 0 && index < statuses.length - 1) {
        return statuses[index + 1];
      }
      return null;
    }
  
    function renderKDS(data) {
      const container = document.getElementById("kds_container");
      container.innerHTML = "";
  
      data.forEach(order => {
        const box = document.createElement("div");
        const css = getStatusClass(order.status);
        const blinking = isBlinking(order.item_list || []) && order.status === "New" ? "blink" : "";
  
        box.className = `table-box ${css} ${blinking}`;
        box.innerHTML = `
          <h4>Table: ${order.table_number}</h4>
          <p>Status: <strong>${order.status}</strong></p>
          <ul>
            ${(order.item_list || []).map(i => `<li>${i.item_name} (${i.kot_status})</li>`).join("")}
          </ul>
        `;
  
        const nextStatus = getNextStatus(order.status);
        if (nextStatus) {
          box.addEventListener("click", () => {
            if (confirm(`Ubah status meja ${order.table_number} ke '${nextStatus}'?`)) {
              updateKDSStatus(order.name, nextStatus);
            }
          });
        }
  
        container.appendChild(box);
      });
    }
  
    async function updateKDSStatus(docname, newStatus) {
      const res = await fetch(`/api/resource/Kitchen Display Order/${docname}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status: newStatus })
      });
  
      const data = await res.json();
      if (data.data) {
        refreshKDS();
      } else {
        alert("Gagal update status.");
      }
    }
  
    function toggleFullscreen() {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
      } else {
        document.exitFullscreen();
      }
    }
  
    async function refreshKDS() {
      const data = await fetchKDSData();
      renderKDS(data);
    }
  </script>
  
  </body>
  </html>
  